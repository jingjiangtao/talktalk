<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="icon" href="/images/favicon.ico">

    <title>小小说说</title>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body{
            font-family: "Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;
            margin:0px;
        }

        /*main的样式*/
        .el-main {
            background-color: #FFF;
            color: #333;
        }

        /*未登录页面页眉*/
        .header{
            background-color: #409EFF;
        }

        /*登录表单*/
        .login-form{
            vertical-align: middle;
            padding: 50px;
            text-align: center;
        }
        .el-form-item{
            margin:20px 0px;
        }

        /*轮播图*/
        .el-carousel{
            border:1px solid #CCC
        }
        .el-carousel__container{
            overflow: hidden;
        }
        .el-carousel__item{
            color: #404040;
            padding-top: 60px;
            padding-left: 60px;
        }
        .el-carousel__item h1 {
            line-height: 100px;
            margin: 10px;
            font-family: Yuanti SC;
            font-size: 50px;
            font-weight:normal;
        }
        .el-carousel__item p{
            margin:10px;
            font-size: 23px;
        }

        /*导航栏*/
        .el-menu-item a{
            text-decoration: none;
        }
        .push-right{
            float:right !important;
        }

        /*动态发布文本域*/
        textarea{
            resize: none !important;
        }
        /*发送动态按钮*/
        .send-btn{
            margin-top: 8px;
        }
        /*剩余字数显示*/
        .last-num{
            line-height: 60px;
            margin-right: 20px;
            color: #CCC;
        }
        /*添加图片按钮*/
        .add-picture-btn{
            margin-top: 8px;
        }

        /*测试边界*/
        .border-test{
            border: 1px red solid;
        }
    </style>
</head>

<body>
<div id="show-index">
   
<div v-if="unlogin">
    <el-container>
        <el-header class="header"></el-header>
        <el-main>
            <el-row type="flex" justify="center">
                <el-col :span="20">
                    <el-carousel :interval="4000" height="300px">
                        <el-carousel-item>
                            <h1>欢迎使用小小说说</h1>
                            <p>要查看或发布动态，请先登录</p>
                        </el-carousel-item>
                        <el-carousel-item>
                            <h1>发布动态</h1>
                            <p>你可以随时把开心的，伤心的，好玩的，有意思的事跟大家分享，只要你愿意。</p>
                        </el-carousel-item>
                        <el-carousel-item>
                            <h1>查看动态</h1>
                            <p>你可以看看别人都碰到了哪些好玩的事，遇到了哪些有趣的人。你也可以点赞，评论。</p>
                        </el-carousel-item>
                        <el-carousel-item>
                            <h1>查看成员</h1>
                            <p>在这里，你可以知道使用小小说说的都是哪些人，他们都有哪些好玩的点子。</p>
                        </el-carousel-item>
                    </el-carousel>
                </el-col>
            </el-row>
            <el-row type="flex" justify="center">
                <el-col :span="8">
                    <el-form ref="form"  label-width="80px" class="login-form">
                        <el-form-item label="用户名：">
                            <el-input v-model="inputUsername"
                                      v-on:keyup.enter.native="loginMethod"
                                      maxlength="10"
                                      type="text"
                                      placeholder="昵称(至少3位 可以中文)"
                                      id="username"></el-input>
                        </el-form-item>
                        <el-form-item label="密码：">
                            <el-input v-model="inputPassword"
                                      v-on:keyup.enter.native="loginMethod"
                                      maxlength="15"
                                      type="password"
                                      placeholder="密码(至少6位)"
                                      id="password"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary"  v-on:click="loginMethod" id="btn-login">登录</el-button>
                            <el-button v-on:click="signinMethod" id="btn-signin">注册</el-button>
                        </el-form-item>
                    </el-form>
                </el-col>
            </el-row>
        </el-main>
    </el-container>
</div>
<div v-else>

    <!--全部说说列表-->
    <div v-if="mainContainer">
        <el-container>
            <el-header>
                <el-row>
                    <el-col :span="18" :offset="3">
                        <el-menu mode="horizontal"
                                 :default-active="'1'">
                            <el-menu-item index="1"><a href="#">所有说说</a></el-menu-item>
                            <el-menu-item index="2"><a href="#">我的说说</a></el-menu-item>
                            <el-menu-item index="3"><a href="#">成员列表</a></el-menu-item>
                            <el-menu-item index="7" class="push-right">
                                <a href="#" v-on:click="quitMethod">退出登录</a>
                            </el-menu-item>
                            <el-menu-item index="6" class="push-right"><a href="#">修改个人信息</a></el-menu-item>
                            <el-menu-item index="5" class="push-right"><a href="#">用户名</a></el-menu-item>
                            <el-menu-item index="4" class="push-right"><a href="#">头像</a></el-menu-item>
                        </el-menu>
                    </el-col>
                </el-row>
            </el-header>
            <el-main>
                <el-row>
                    <el-col :span="16" :offset="4">
                        <el-input
                                type="textarea"
                                :rows="7"
                                placeholder="有什么想和大家分享的？"
                                v-model="inputStatusContent">
                        </el-input>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="2" :offset="4">
                        <el-button icon="el-icon-picture" class="add-picture-btn">添加图片</el-button>
                    </el-col>
                    <el-col :span="2" :offset="12">
                        <span class="last-num">{{lastNum}}</span>
                        <el-button type="success" class="push-right send-btn">发送</el-button>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="16" :offset="4">
                        <el-upload
                                action="/"
                                list-type="picture-card">
                            <i class="el-icon-plus"></i>
                        </el-upload>
                    </el-col>
                </el-row>
            </el-main>
        </el-container>
    </div>

    <!--我的说说列表-->
    <div v-if="myTalklist">
        <el-container>
            <el-header class="header"></el-header>
            <el-main>

            </el-main>
        </el-container>
    </div>

    <!--成员列表-->
    <div v-if="memberlist" class="container member-list">
        <el-container>
            <el-header class="header"></el-header>
            <el-main>

            </el-main>
        </el-container>
    </div>
</div>

</div>

<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>

<!--页面自身的js文件-->
<script>

    // 错误警告框
    Vue.component('alert-box', {
        props:['text1','text2'],
        template: `
                    <div class="alert alert-danger" role="alert">
                         <strong>{{text1}}</strong><span>{{text2}}</span>
                    </div>
                  `
    });

    // 成功提示框
    Vue.component('alert-box-success', {
        props:['text1','text2'],
        template: `
                    <div class="alert alert-success" role="alert">
                         <strong>{{text1}}</strong><span>{{text2}}</span>
                    </div>
                  `
    });

    var indexShow = new Vue({
        el:'#show-index',
        data: {
            //页面初始化参数
            unlogin:true,
            username:'',
            avatar:'',
            listResult: [],
            //登陆注册输入框参数
            inputUsername:'',
            inputPassword:'',
            //发表动态文本框参数
            inputStatusContent:'',
            lastNum:300,
            // 控制三个页面切换参数
            mainContainer:true,
            myTalklist:false,
            memberlist:false,
            // 我的说说页面数据
            myTalkResult:[],
            //所有用户页面数据
            memberResult:[],
            //回复框中的值
            replyTextarea:'',
            //是否显示警告框
            alertDis:false,
            alertDis2:false,
            //警告框中的信息
            text1:'',
            text2:'',
            //文件选择
            files:null,
            imagesShow:false,
            //签名内容
            signature:'',
            // 签名修改提示框
            successDis:false
        },
        created: function () {
            var _this = this;
            $.get('/getindexdata',function(data, status){
                _this.unlogin = data.unlogin;
                _this.username = data.username;
                _this.avatar = data.avatar;
                _this.listResult = data.listResult;
                _this.signature = data.signature;
                for(var i=0;i<_this.listResult.length;i++){
                    if(_this.myTalkResult.indexOf(_this.listResult[i])==-1 &&
                        _this.listResult[i].username == _this.username){
                        _this.myTalkResult.push(_this.listResult[i]);
                    }
                }
            });
        },

        methods: {

            //判断当前的动态点赞图标是否应该高亮
            isZan: function (result) {

                if(result.zanPerson.indexOf(this.username) != -1){
                    return {
                        'zaned':true
                    };
                }else{
                    return {
                        'zaned':false
                    };
                }
            },
            //给自己的动态添加样式
            isOwn:function(result){
                if(result.username==this.username){
                    return {
                        'panel':true,
                        'panel-default':false,
                        'panel-primary':true
                    }
                }else{
                    return {
                        'panel':true,
                        'panel-default':true,
                        'panel-primary':false
                    }
                }
            },
            //登录按钮点击
            loginMethod: function(){
                var _this = this;
                if(!this.inputUsername||!this.inputPassword){

                    this.alertDis = true;
                    this.text1 = '注意！';
                    this.text2 = '用户名和密码不能为空';
                    return;
                }
                if(this.inputUsername.length<3 || this.inputPassword.length<6){

                    this.alertDis = true;
                    this.text1 = '注意！';
                    this.text2 = '用户名要多于3位 密码要多于6位';
                    return;
                }
                $.post('/dologin', {
                    username: this.inputUsername,
                    password: this.inputPassword
                }, function(data, status){
                    if(data.result==1){
                        //登录成功
                        window.location.href="/";
                    }
                    else if(data.result==-1){
                        // 用户名不存在

                        _this.alertDis = true;
                        _this.text1 = '登录失败！';
                        _this.text2 = '用户名不存在';
                    }
                    else if(data.result==-2){
                        // 密码错误

                        _this.alertDis = true;
                        _this.text1 = '登录失败！';
                        _this.text2 = '密码错误';
                    }else{
                        // 未知错误
                        //alertDanger('登录失败！', '未知错误');
                        _this.alertDis = true;
                        _this.text1 = '登录失败！';
                        _this.text2 = '未知错误';
                    }
                });
            },
            // 注册按钮点击事件
            signinMethod: function(){
                var _this = this;
                if(!this.inputUsername||!this.inputPassword){

                    _this.alertDis = true;
                    _this.text1 = '注意！';
                    _this.text2 = '用户名和密码不能为空';
                    return;
                }
                if(this.inputUsername.length<3 || this.inputPassword.length<6){

                    _this.alertDis = true;
                    _this.text1 = '注意！';
                    _this.text2 = '用户名要多于3位 密码要多于6位';
                    return;
                }
                $.post('/dosign', {
                    username: this.inputUsername,
                    password: this.inputPassword
                }, function(data, status){
                    if(data.result==1){
                        window.location.href="/";
                    }
                    else if(data.result == -2){
                        // 未知错误

                        _this.alertDis = true;
                        _this.text1 = '注册失败';
                        _this.text2 = '未知错误';
                    }
                    else{
                        // 注册失败

                        _this.alertDis = true;
                        _this.text1 = '注册失败';
                        _this.text2 = '用户名已存在';
                    }
                });
            },
            // 发送动态按钮点击事件
            sendStatus: function(){
                if(this.inputStatusContent.length==0){
                    return;
                }
                var _this = this;
                $.get('/sendstate', {
                    'talkContent': this.inputStatusContent,
                    'talkImages':_this.files
                }, function(data, status){
                    if(data.result==1){
                        var newStatus = {
                            _id:data._id,
                            avatarPath:_this.avatar,
                            commentContent:[],
                            commentNum:0,
                            talkContent:_this.inputStatusContent,
                            time:(new Date()),
                            username:_this.username,
                            zanNum:0,
                            zanPerson:[],
                            talkImages:_this.files,
                        };
                        _this.listResult.unshift(newStatus);
                        _this.myTalkResult.unshift(newStatus);
                        _this.inputStatusContent='';
                        _this.lastNum = 300;
                        _this.imagesShow = false;
                        _this.files = null;
                    }else{

                    }
                });
            },
            //判断动态列表中的图片容器是否需要显示
            showImagesCon: function(result){
                if(!result.talkImages || result.talkImages.length==0){
                    return false;
                }else{
                    return true;
                }
            },
            // 监听发送动态文本框的改变
            changeLastNum: function(){
                var size = this.inputStatusContent.length;
                this.lastNum = 300 - size;
            },
            // 退出账户
            quitMethod: function () {
                $.get('/quit',function(data, status){
                    if(data.result==1){
                        window.location.href = '/';
                    }else{
                        alertDanger('错误', '退出失败');
                    }
                });
            },
            // 显示所有说说页面
            allTalk: function () {
                this.mainContainer = true;
                this.myTalklist = false;
                this.memberlist = false;
            },
            // 显示我的说说页面
            myTalk: function () {
                var _this = this;
                _this.mainContainer = false;
                _this.memberlist = false;
                _this.myTalklist = true;
            },
            // 显示成员列表页面
            members: function () {
                this.mainContainer = false;
                this.myTalklist = false;
                this.memberlist = true;
                var _this = this;
                $.get('/allmembers', function(data, status) {
                    if (data.result == 1) {
                        _this.memberResult = data.userList;
                    }
                });
            },
            //删除我的说说
            deleteMyTalk:function (currList) {
                var _this = this;
                $.get('/deletetalk', {
                    '_id':currList._id
                }, function(data, status){
                    if(data.result==1){
                        var index = _this.myTalkResult.indexOf(currList);
                        _this.myTalkResult.splice(index, 1);
                        index = _this.listResult.indexOf(currList);
                        _this.listResult.splice(index, 1);
                    }
                });
            },
            // 点赞
            zan: function (currList) {
                var _this = this;
                if(currList.zanPerson.indexOf(_this.username) != -1){
                    $.get('/docancelzan',{
                        '_id':currList._id,
                        'username':currList.username
                    }, function (data, status) {
                        if(data.result==1){
                            //取消赞高亮
                            currList.zanPerson.splice(currList.zanPerson.indexOf(_this.username),1);
                            currList.zanNum -= 1;
                            return;
                        }
                    });
                }else{
                    $.get('/dozan', {
                        '_id':currList._id,
                        'username':currList.username
                    }, function(data, status){
                        if(data.result==1){
                            // 添加赞高亮
                            currList.zanPerson.push(_this.username);
                            currList.zanNum += 1;
                            return;
                        }
                    });
                }
            },
            //回复按钮
            replayBtn: function(currList){
                var _this = this;
                if(_this.replyTextarea.length==0){
                    return;
                }
                $.get('/replay',{
                    'textContent':_this.replyTextarea,
                    'replyUsername': currList.username,
                    '_id': currList._id
                }, function(data, status){
                    if(data.result==1){
                        currList.commentContent.unshift({
                            'replyUser':data.replyUser,
                            'replyContent':_this.replyTextarea,
                            'replyTime':data.replyTime
                        });
                        currList.commentNum += 1;
                        _this.replyTextarea = '';
                    }
                });
            },
            // 评论中回复
            replyToUser: function (comment) {
                this.replyTextarea = '@'+comment.replyUser+'： ';
            },
            // 修改密码模态框的确定按钮
            updatePwd: function () {
                var oldPwd = document.getElementById('old-pwd').value;
                var newPwd = document.getElementById('new-pwd').value;
                var okNewPwd = document.getElementById('ok-new-pwd').value;
                var _this = this;
                if(!oldPwd || !newPwd || !okNewPwd){

                    _this.alertDis2 = true;
                    _this.text1 = '注意！';
                    _this.text2 = '输入框不能为空';
                    return;
                }

                if(oldPwd.length < 6 || newPwd.length < 6 || okNewPwd.length < 6){

                    _this.alertDis2 = true;
                    _this.text1 = '注意！';
                    _this.text2 = '密码应不少于6位';
                    return;
                }

                if(newPwd != okNewPwd){

                    _this.alertDis2 = true;
                    _this.text1 = '注意！';
                    _this.text2 = '两次输入的密码不一致';
                    return;
                }

                $.post('/updatepwd', {
                    oldPwd:oldPwd,
                    newPwd:newPwd
                }, function(data, status){
                    if(data.result==1){
                        $('#modify-profile').modal('hide');
                        window.location.href = '/';
                    }
                    else if(data.result==-1){

                        _this.alertDis2 = true;
                        _this.text1 = '未知错误！';
                        _this.text2 = '修改失败';
                    }
                    else if(data.result==-2){

                        _this.alertDis2 = true;
                        _this.text1 = '修改失败！';
                        _this.text2 = '旧密码不正确';
                    }
                    else if(data.result==-3){

                        _this.alertDis2 = true;
                        _this.text1 = '修改失败！';
                        _this.text2 = '新密码不能与旧密码相同';
                    }
                });
            },
            // 上传图片
            uploadImg: function (event) {
                var _this = this;
                this.files = event.target.files;
                let form = new FormData();
                var imgNum = 0;
                if(this.files.length>3){
                    imgNum = 3;
                }else{
                    imgNum = this.files.length;
                }
                for(let i=0;i<imgNum;i++){
                    form.append('imgs', this.files[i]);
                }

                $.ajax({
                    url: "/uploadImg",
                    data: form,
                    type: "post",
                    processData: false,
                    contentType : false,
                    dataType: 'json',
                    success: function (re) {
                        if(re.result==1){
                           _this.files = re.imgList;
                           _this.imagesShow = true;
                           document.getElementById('file-upload').value = '';
                        }
                    }
                });
            },
            // 修改签名
            modifySign: function () {
                var _this = this;
                $.get('/modifysign',{
                    'signature':_this.signature
                },function (data, status) {
                    if(data.result==1){
                        _this.successDis = true;
                    }
                });
            }
        }
    });
</script>
</body>
</html>
